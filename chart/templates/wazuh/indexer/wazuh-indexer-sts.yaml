apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ .Release.Name }}-indexer
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ .Release.Name }}-indexer
    node-type: index
    {{- with .Values.global.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  replicas: {{ .Values.indexer.replicas }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}-indexer
      node-type: index
  serviceName: {{ .Release.Name }}-indexer-cluster
  podManagementPolicy: Parallel
  updateStrategy:
    type: {{ .Values.indexer.strategy.type | default "RollingUpdate" }}
    {{- if eq (.Values.indexer.strategy.type | default "RollingUpdate") "RollingUpdate" }}
    rollingUpdate:
      maxUnavailable: {{ .Values.indexer.strategy.rollingUpdate.maxUnavailable | default 1 }}
    {{- end }}
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-indexer
        node-type: index
        {{- with .Values.global.labels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      annotations:
        checksum/config: {{ include "wazuh.indexer.config" . | sha256sum }}
        {{- with .Values.global.annotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.global.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.global.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.indexer.antiAffinity }}
      {{- if .Values.indexer.antiAffinity.enabled }}
      affinity:
        podAntiAffinity:
          {{- if eq .Values.indexer.antiAffinity.type "hard" }}
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: {{ .Release.Name }}-indexer
              topologyKey: {{ .Values.indexer.antiAffinity.topologyKey | default "kubernetes.io/hostname" }}
          {{- else }}
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: {{ .Release.Name }}-indexer
                topologyKey: {{ .Values.indexer.antiAffinity.topologyKey | default "kubernetes.io/hostname" }}
          {{- end }}
      {{- end }}
      {{- else if .Values.global.affinity }}
      affinity:
        {{- toYaml .Values.global.affinity | nindent 8 }}
      {{- end }}
      
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      
      # Init container to set proper permissions and wait for DNS
      initContainers:
        - name: sysctl
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
            privileged: true
          command:
            - sh
            - -c
            - |
              # Increase virtual memory for OpenSearch
              sysctl -w vm.max_map_count=262144 || true
          resources:
            limits:
              cpu: 100m
              memory: 64Mi
            requests:
              cpu: 10m
              memory: 32Mi
        
        - name: init-permissions
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 0
          command:
            - sh
            - -c
            - |
              # Ensure data directory has correct ownership
              chown -R 1000:1000 /var/lib/wazuh-indexer
              chmod 750 /var/lib/wazuh-indexer
          volumeMounts:
            - name: data
              mountPath: /var/lib/wazuh-indexer
          resources:
            limits:
              cpu: 100m
              memory: 64Mi
            requests:
              cpu: 10m
              memory: 32Mi
      
      containers:
        - name: wazuh-indexer
          image: {{ .Values.indexer.image.repository }}:{{ .Values.wazuh.tag }}
          imagePullPolicy: {{ .Values.global.imagePullPolicy | default "IfNotPresent" }}
          
          env:
            # Node identity - used in opensearch.yml via ${NODE_NAME}
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            
            # JVM settings
            - name: OPENSEARCH_JAVA_OPTS
              value: {{ .Values.indexer.javaOpts | quote }}
            
            # Memory lock for performance
            - name: bootstrap.memory_lock
              value: "true"
            
            # Credentials for health checks
            - name: INDEXER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-indexer-creds
                  key: username
            - name: INDEXER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Release.Name }}-indexer-creds
                  key: password
          
          ports:
            - name: http
              containerPort: 9200
              protocol: TCP
            - name: transport
              containerPort: 9300
              protocol: TCP
          
          resources:
            {{- toYaml .Values.indexer.resources | nindent 12 }}
          
          volumeMounts:
            # Main configuration
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch.yml
              subPath: opensearch.yml
              readOnly: true
            
            # Security plugin configuration
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/internal_users.yml
              subPath: internal_users.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/roles.yml
              subPath: roles.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/roles_mapping.yml
              subPath: roles_mapping.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/action_groups.yml
              subPath: action_groups.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/tenants.yml
              subPath: tenants.yml
              readOnly: true
            - name: config
              mountPath: /usr/share/wazuh-indexer/config/opensearch-security/config.yml
              subPath: config.yml
              readOnly: true
            
            # Data volume
            - name: data
              mountPath: /var/lib/wazuh-indexer
            
            # Certificates
            - name: certs-root
              mountPath: /usr/share/wazuh-indexer/config/certs/root-ca.pem
              subPath: ca.crt
              readOnly: true
            - name: certs-indexer
              mountPath: /usr/share/wazuh-indexer/config/certs/wazuh.indexer.pem
              subPath: tls.crt
              readOnly: true
            - name: certs-indexer
              mountPath: /usr/share/wazuh-indexer/config/certs/wazuh.indexer.key
              subPath: tls.key
              readOnly: true
            - name: certs-admin
              mountPath: /usr/share/wazuh-indexer/config/certs/admin.pem
              subPath: tls.crt
              readOnly: true
            - name: certs-admin
              mountPath: /usr/share/wazuh-indexer/config/certs/admin-key.pem
              subPath: tls.key
              readOnly: true
          
          {{- if .Values.indexer.startupProbe.enabled }}
          startupProbe:
            tcpSocket:
              port: transport
            initialDelaySeconds: {{ .Values.indexer.startupProbe.initialDelaySeconds | default 10 }}
            periodSeconds: {{ .Values.indexer.startupProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.indexer.startupProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.indexer.startupProbe.failureThreshold | default 30 }}
          {{- end }}
          
          {{- if .Values.indexer.livenessProbe.enabled }}
          livenessProbe:
            tcpSocket:
              port: transport
            initialDelaySeconds: {{ .Values.indexer.livenessProbe.initialDelaySeconds | default 60 }}
            periodSeconds: {{ .Values.indexer.livenessProbe.periodSeconds | default 30 }}
            timeoutSeconds: {{ .Values.indexer.livenessProbe.timeoutSeconds | default 5 }}
            failureThreshold: {{ .Values.indexer.livenessProbe.failureThreshold | default 5 }}
          {{- end }}
          
          {{- if .Values.indexer.readinessProbe.enabled }}
          readinessProbe:
            exec:
              command:
                - sh
                - -c
                - |
                  #!/bin/sh
                  # Check cluster health with authentication
                  RESPONSE=$(curl -sk -u "${INDEXER_USERNAME}:${INDEXER_PASSWORD}" \
                    "https://localhost:9200/_cluster/health?local=true" 2>/dev/null)
                  
                  # Check if response contains green or yellow status
                  echo "$RESPONSE" | grep -qE '"status":"(green|yellow)"'
            initialDelaySeconds: {{ .Values.indexer.readinessProbe.initialDelaySeconds | default 30 }}
            periodSeconds: {{ .Values.indexer.readinessProbe.periodSeconds | default 10 }}
            timeoutSeconds: {{ .Values.indexer.readinessProbe.timeoutSeconds | default 10 }}
            failureThreshold: {{ .Values.indexer.readinessProbe.failureThreshold | default 5 }}
          {{- end }}
      
      volumes:
        - name: config
          configMap:
            name: {{ .Release.Name }}-indexer-conf
        - name: certs-root
          secret:
            secretName: {{ include "wazuh.rootCASecretName" . }}
        - name: certs-indexer
          secret:
            secretName: {{ .Release.Name }}-indexer
        - name: certs-admin
          secret:
            secretName: {{ .Release.Name }}-admin
  
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app: {{ .Release.Name }}-indexer
      spec:
        accessModes: 
          - {{ .Values.indexer.persistence.accessMode | default "ReadWriteOnce" }}
        {{- if and .Values.indexer.persistence.storageClass (ne .Values.indexer.persistence.storageClass "") }}
        storageClassName: {{ .Values.indexer.persistence.storageClass | quote }}
        {{- else if and .Values.global.storageClass (ne .Values.global.storageClass "") }}
        storageClassName: {{ .Values.global.storageClass | quote }}
        {{- end }}
        resources:
          requests:
            storage: {{ .Values.indexer.persistence.size | default "50Gi" }}